✅ 文本转有声书系统 - 完整开发需求文档（V1.0）

📌 1. 产品概述

本系统的目标是将完整小说文本自动转换成可听的有声书内容，包括文本解析、台本生成、语音合成、音频拼接及时间轴字幕（如 LRC/SRT）。
系统支持大文本上传（≤20MB）并按分段处理，同时维护全书级人物表，确保跨段声线一致、人物身份统一。

⸻

📌 2. 核心功能需求

✅ 2.1 文本上传模块
	•	支持用户上传完整小说文本
	•	支持格式：.txt、.md、可扩展 .doc/.docx
	•	单次上传限制 ≤ 20MB
	•	后台进入处理队列，可异步任务处理
	•	解析处理前执行编码检测与转换

⸻

✅ 2.2 文本清洗与结构解析
	•	清理网页残留内容、空行、不可见字符
	•	自动识别章节、段落、对话、引用格式
	•	NLP识别人物名称、对话边界、旁白内容
	•	输出统一格式的纯净文本 + 章节节点

⸻

✅ 2.3 自动分段（内容分片）
	•	将文本按逻辑切分为多个片段
	•	默认每段 ≤ 10,000 字，可配置
	•	分段规则：
✅ 不截断句子
✅ 优先在段落或章节边界切分
✅ 若章节过大，可继续细分
	•	分段输出示例：

[
  { "id": 1, "start": 0, "end": 9850, "content": "..." },
  { "id": 2, "start": 9851, "end": 19800, "content": "..." }
]


⸻

✅ 2.4 台本生成（结构化脚本）

每个分段会被解析成结构化台本（JSON 数组），每句话包含以下字段：

{
  "speaker": "旁白 / 角色名称",
  "text": "句子内容",
  "tone": "平静 / 激动 / 悲伤 / 冷漠 / 幽默 ...",
  "strength": 0-100,
  "pause_after": 0.0-5.0
}

生成策略：
	•	自动拆分长句
	•	自动判断说话人（引用、冒号、对话模式）
	•	NLP分析情绪生成 tone & strength
	•	旁白与角色句子分开处理

⸻

✅ 2.5 ✅ 全局人物表（跨段共享）

由于分段独立处理，为确保角色声线一致，本系统必须维护一个全书级人物表。

功能要求：
✔ 所有句子中出现的角色最终映射到统一角色ID
✔ 支持识别别名、绰号、简称（如“林黛玉”→“黛玉/林姑娘”）
✔ 每角色绑定统一声线（TTS配置）
✔ 支持人工审查和角色合并
✔ 支持旁白作为独立固定角色

⸻

2.5.1 人物表字段设计

字段	描述
canonical_name	规范角色名，如“林黛玉”
aliases	别名数组、置信度、来源语句
gender_hint, age_hint	声线推荐参考
emotion_baseline	此角色默认语气（如平静、轻柔、强势）
tts_profile	绑定的声线配置（如 voice_name、pitch、rate）
is_active	标记是否有效（合并后失效）


⸻

✅ 2.6 人物识别与合并机制
	•	NLP识别对话人名、上下文共指、代词解析
	•	别名匹配规则：姓名、简称、敬称（“老张”“小王”“林姑娘”）
	•	模糊匹配、语义相似度比对
	•	多段出现的相同角色自动归并
	•	若系统不确定 → 生成“角色合并建议”供人工确认
	•	合并后：
	•	旧角色的句子自动转向新角色ID
	•	声线统一
	•	写入合并审计供回溯

⸻

✅ 2.7 TTS语音合成
	•	按句生成语音，单位粒度：台本的每条记录
	•	支持多个TTS提供商：Azure / Edge-TTS / XTTS / OpenAI TTS 等
	•	语调与力度按 tone & strength 影响参数
	•	不同角色使用不同声线
	•	生成后返回句子音频时长，写回数据库

输出示例：

{
  "sentence_id": 218,
  "file": "sentence_218.wav",
  "duration": 1.82,
  "start_time": 182.5,
  "end_time": 184.3
}


⸻

✅ 2.8 音频拼接
	•	以分段为单位，将多句音频合并成1个完整片段音频
	•	按 pause_after 插入停顿
	•	输出格式：mp3 / wav
	•	支持整本书一次拼接

输出：

part_001.mp3
part_002.mp3
...
book_full.mp3


⸻

✅ 2.9 时间轴字幕（LRC / SRT / JSON）

根据句子的起止时间生成字幕文件：

LRC 示例：

[00:00.00]第一句旁白内容
[00:02.15]角色A：你来了？

JSON 示例：

[
  { "text": "你来了？", "speaker": "角色A", "start": 2.15, "end": 4.90 }
]

这些数据可用于播放器逐句高亮。

⸻

✅ 2.10 最终输出内容

每个分段输出：

类型	示例
音频文件	part_01.mp3
字幕文件	part_01.lrc / .srt / .json
台本结构文件	part_01_script.json

整本书输出：
	•	book_full.mp3
	•	book_full.lrc / .srt

⸻

📌 3. 系统工作流程（端到端）

步骤流程：
	1.	用户上传文本
	2.	文本清洗、解析
	3.	自动分段
	4.	生成台本（结构化脚本）
	5.	写入人物索引并维护全局人物表
	6.	逐句 TTS 语音生成
	7.	拼接音频
	8.	生成带时间轴的 LRC/SRT
	9.	输出音频文件 + 字幕
	10.	支持人工调校（人物合并、声线更换）与批量重渲

⸻

📌 4. 数据库模型（核心）

4.1 书籍表 book
	•	id, title, author

4.2 全局人物表 character
	•	canonical_name
	•	gender_hint / age_hint
	•	emotion_baseline
	•	tts_profile_id
	•	is_active

4.3 别名表 character_alias
	•	alias
	•	confidence
	•	链接到 character_id

4.4 声线配置表 tts_profile
	•	vendor, voice_name, pitch, rate, style

4.5 台本句子表 script_sentence
	•	raw_speaker（模型识别）
	•	character_id（全局人物映射）
	•	text / tone / strength / pause_after / duration / 时间戳

4.6 角色合并审计 character_merge_audit

⸻

📌 5. API 需求（简版）

方法	路径	功能
POST	/upload	上传小说文本
GET	/books/{id}/characters	获取人物表
POST	/books/{id}/characters/merge	合并两个角色
POST	/books/{id}/render	生成音频 & 字幕
GET	/books/{id}/download	打包下载所有输出


⸻

📌 6. 非功能性要求
	•	任务异步执行（建议：任务队列 Celery/Redis）
	•	大文本分批处理，防止 OOM
	•	音频生成失败支持重试
	•	人物表为全局共享，多个分段重复处理不会生成新声线
	•	支持断点恢复（例如生成到第 8 段中断，可继续）

⸻

📌 7. 可扩展功能（未来版本）
	•	多语支持、英文/日文书籍处理
	•	声线训练（克隆角色音色）
	•	背景音乐混入
	•	Web 播放器实时逐句高亮
	•	用 LLM 自动补全角色简介与标签
	•	支持用户上传自定义声音

⸻
