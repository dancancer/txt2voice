# 实施计划

## 任务列表

将功能设计转换为一系列代码生成LLM的提示，以测试驱动的方式实现每个步骤。优先考虑最佳实践、增量进度和早期测试，确保在任何阶段都不会出现复杂性的大跳跃。每个提示都建立在之前的基础上，最终整合所有内容。

- [ ] 1. 建立项目基础架构和数据库模型
  - 安装和配置Next.js 16 + TypeScript + Hono
  - 配置Prisma ORM和PostgreSQL数据库
  - 实现完整的数据库schema（books, character_profiles, tts_voice_profiles等）
  - 创建基础的TypeScript类型定义
  - 设置基础的API路由结构
  - _需求: 2.1, 2.5, 2.5.1_

- [ ] 2. 实现文件上传和基础文本处理
  - [ ] 2.1 创建文件上传API端点
    - 实现POST /api/books/[id]/upload端点
    - 添加文件大小和格式验证（≤20MB, .txt/.md）
    - 实现文件存储和基础元数据保存
    - 添加错误处理和响应格式
    - _需求: 2.1_

  - [ ] 2.2 实现文本清洗和编码检测
    - 创建TextCleaningService类
    - 实现编码检测和转换功能
    - 清理网页残留内容和不可见字符
    - 编写单元测试验证清洗功能
    - _需求: 2.2_

  - [ ] 2.3 实现自动分段功能
    - 创建TextSegmentationService
    - 实现按逻辑切分文本的算法（≤10,000字/段）
    - 确保不截断句子，优先在段落/章节边界切分
    - 生成segment数据并保存到数据库
    - _需求: 2.3_

- [ ] 3. 开发LLM台本生成Agent核心功能
  - [ ] 3.1 创建LLM客户端和基础Agent框架
    - 实现LLMClient类支持OpenAI/Anthropic API
    - 创建ScriptGenerationAgent基础类
    - 实现缓存机制（Redis）
    - 添加错误处理和重试机制
    - _需求: 2.4, 2.7_

  - [ ] 3.2 实现角色识别功能
    - 创建角色识别prompt模板
    - 实现角色识别和别名匹配算法
    - 开发角色消歧和合并机制
    - 保存识别结果到character_profiles表
    - _需求: 2.6_

  - [ ] 3.3 实现情绪分析功能
    - 创建情绪分析prompt模板
    - 实现情绪强度和类型识别
    - 映射情绪到TTS参数（音调、语速、音量）
    - 为每个句子添加情绪标注
    - _需求: 2.4_

  - [ ] 3.4 实现台本结构化生成
    - 创建台本结构化prompt模板
    - 实现语句分割和优化
    - 生成完整的script_sentences数据
    - 添加质量验证和自动修复功能
    - _需求: 2.4, 2.7_

- [ ] 4. 构建TTS声线管理系统
  - [ ] 4.1 实现TTS提供商适配器
    - 创建TTSService接口和基础实现
    - 实现Azure TTS适配器
    - 实现OpenAI TTS适配器
    - 实现Edge-TTS适配器
    - 添加提供商健康检查和降级机制
    - _需求: 2.7_

  - [ ] 4.2 创建声线配置和管理
    - 实现tts_voice_profiles表的CRUD操作
    - 创建声线特征数据结构
    - 实现声线使用统计和评分系统
    - 添加声线可用性管理
    - _需求: 2.5.1_

  - [ ] 4.3 实现声线预览系统
    - 创建VoicePreviewService
    - 实现预览音频生成和缓存
    - 根据声线特征选择合适的预览文本
    - 添加预览音频上传和存储功能
    - _需求: 声线预览功能_

- [ ] 5. 开发智能声线匹配和绑定系统
  - [ ] 5.1 实现声线匹配算法
    - 创建VoiceMatchingService
    - 实现多维度匹配算法（性别、年龄、风格等）
    - 计算角色与声线的匹配度分数
    - 为单个角色推荐最佳声线列表
    - _需求: 智能声线推荐_

  - [ ] 5.2 实现批量声线分配
    - 开发避免声线冲突的算法
    - 按角色重要性排序分配声线
    - 实现自动分配功能
    - 添加分配结果优化和调整
    - _需求: 角色声线绑定_

  - [ ] 5.3 创建角色声线绑定管理
    - 实现character_voice_bindings表的CRUD操作
    - 支持自定义参数覆盖和情绪映射
    - 添加绑定历史记录和审计功能
    - 实现绑定状态管理
    - _需求: 角色声线绑定_

- [ ] 6. 构建音频生成和处理系统
  - [ ] 6.1 实现单句TTS合成
    - 扩展TTSService支持单句合成
    - 集成角色声线绑定参数
    - 实现情绪参数映射应用
    - 添加合成结果验证和错误处理
    - _需求: 2.7_

  - [ ] 6.2 实现音频拼接功能
    - 创建AudioProcessingService
    - 实现多句音频合并（考虑pause_after）
    - 支持不同音频格式输出（MP3/WAV）
    - 生成分段音频和完整书籍音频
    - _需求: 2.8_

  - [ ] 6.3 实现时间轴字幕生成
    - 创建SubtitleService
    - 生成LRC格式字幕文件
    - 生成SRT格式字幕文件
    - 生成JSON格式时间轴数据
    - 确保时间戳与音频文件同步
    - _需求: 2.9_

- [ ] 7. 开发前端用户界面
  - [ ] 7.1 创建文件上传和项目管理界面
    - 实现文件拖拽上传组件
    - 创建项目列表和管理界面
    - 添加上传进度显示和错误提示
    - 实现项目状态监控
    - _需求: 2.1_

  - [ ] 7.2 实现角色管理界面
    - 创建角色列表和详情显示
    - 实现角色合并和编辑功能
    - 添加角色特征标签管理
    - 支持角色关系和别名管理
    - _需求: 2.6_

  - [ ] 7.3 构建声线选择和绑定界面
    - 实现VoiceAssignment组件
    - 创建声线预览播放器
    - 添加声线参数调节控件
    - 实现智能分配和手动绑定功能
    - _需求: 声线管理界面_

  - [ ] 7.4 创建台本预览和编辑界面
    - 实现台本内容显示和编辑
    - 添加角色和情绪高亮显示
    - 支持台本导出和导入
    - 实现台本版本管理和回滚
    - _需求: 台本编辑功能_

  - [ ] 7.5 构建音频生成和下载界面
    - 创建生成进度监控面板
    - 实现音频预览播放器
    - 添加批量下载功能
    - 支持生成设置和参数配置
    - _需求: 2.10_

- [ ] 8. 实现任务队列和异步处理
  - [ ] 8.1 配置Bull任务队列
    - 设置Redis和Bull队列
    - 创建任务类型定义（文本处理、台本生成、音频渲染）
    - 实现任务优先级和并发控制
    - 添加任务监控和管理界面
    - _需求: 异步处理需求_

  - [ ] 8.2 实现台本生成队列处理
    - 创建script-generation队列处理器
    - 实现批量处理和错误重试
    - 添加进度更新和状态通知
    - 实现任务取消和恢复功能
    - _需求: 2.4_

  - [ ] 8.3 实现音频渲染队列处理
    - 创建audio-render队列处理器
    - 实现分段并行音频合成
    - 添加音频拼接和后处理
    - 实现失败重试和降级策略
    - _需求: 2.7, 2.8_

- [ ] 9. 构建完整的API端点
  - [ ] 9.1 实现书籍管理API
    - GET /api/books - 获取书籍列表
    - GET /api/books/[id] - 获取书籍详情
    - POST /api/books/[id]/upload - 上传文件
    - POST /api/books/[id]/reparse - 重新解析
    - _需求: 2.1, 2.2_

  - [ ] 9.2 实现角色和台本API
    - GET /api/books/[id]/characters - 获取角色列表
    - POST /api/books/[id]/characters/merge - 合并角色
    - GET /api/books/[id]/script - 获取台本
    - POST /api/script-agent - 触发台本生成
    - _需求: 2.4, 2.6_

  - [ ] 9.3 实现声线和音频API
    - GET /api/tts/voices - 获取声线列表
    - POST /api/tts/voices/[id]/preview - 生成预览
    - GET /api/books/[id]/voice-bindings - 获取绑定
    - POST /api/books/[id]/voice-bindings - 创建绑定
    - POST /api/books/[id]/render - 开始音频渲染
    - GET /api/books/[id]/render/progress - 获取进度
    - GET /api/books/[id]/download - 下载音频
    - _需求: 声线管理和音频生成_

- [ ] 10. 实现系统集成和优化
  - [ ] 10.1 创建端到端工作流
    - 集成文件上传到音频生成的完整流程
    - 实现工作流状态管理和错误恢复
    - 添加工作流进度监控和通知
    - 创建工作流测试和验证
    - _需求: 完整工作流程_

  - [ ] 10.2 实现缓存和性能优化
    - 优化数据库查询和索引
    - 实现API响应缓存
    - 添加静态资源优化
    - 实现并发控制和限流
    - _需求: 性能要求_

  - [ ] 10.3 添加监控和日志系统
    - 实现结构化日志记录
    - 添加性能监控和指标收集
    - 创建错误追踪和报警
    - 实现健康检查端点
    - _需求: 系统监控_

- [ ] 11. 编写测试套件
  - [ ] 11.1 单元测试
    - 测试所有服务类和工具函数
    - 测试数据模型和验证逻辑
    - 测试API路由处理函数
    - 确保测试覆盖率达到80%以上
    - _需求: 质量保证_

  - [ ] 11.2 集成测试
    - 测试完整的API工作流
    - 测试数据库操作和事务
    - 测试TTS服务集成
    - 测试任务队列处理
    - _需求: 系统集成验证_

  - [ ] 11.3 端到端测试
    - 使用Playwright测试完整用户流程
    - 测试文件上传到音频下载的完整流程
    - 测试不同浏览器的兼容性
    - 测试大文件处理性能
    - _需求: 用户体验验证_

- [ ] 12. 部署配置和文档
  - [ ] 12.1 创建部署配置
    - 配置Docker容器化部署
    - 创建docker-compose.yml文件
    - 配置环境变量和密钥管理
    - 设置数据库迁移脚本
    - _需求: 部署架构_

  - [ ] 12.2 编写API文档和使用指南
    - 创建详细的API文档
    - 编写用户使用手册
    - 添加开发者集成指南
    - 创建故障排除文档
    - _需求: 文档完善_