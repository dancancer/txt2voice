# Agent 工作流程文档

## 概述

本文档详细描述了 Text to Voice 系统中各个 Agent（智能代理）的工作流程、职责和交互方式。

## Agent 架构

### 系统 Agent 组成

1. **任务协调 Agent** - 负责任务创建、调度和进度跟踪
2. **文本处理 Agent** - 负责文件解析、清洗和分段
3. **角色分析 Agent** - 负责识别角色和分析特征
4. **台本生成 Agent** - 负责生成朗读台本
5. **音频生成 Agent** - 负责调用 TTS 生成音频

## 1. 任务协调 Agent

**实现**: `src/lib/processing-task-utils.ts` + API Routes

**职责**:
- 接收用户请求
- 创建处理任务
- 协调各 Agent 工作
- 跟踪任务进度
- 处理错误异常

**任务类型**:
- `text_processing` - 文本处理
- `character_analysis` - 角色分析
- `script_generation` - 台本生成
- `audio_generation` - 音频生成

**状态流转**: `pending → processing → completed/failed`

## 2. 文本处理 Agent

**实现**: `src/lib/text-processor.ts`

**工作流程**:
```
输入文件 → 编码检测 → 文本清洗 → 格式检测 → 智能分段 → 类型识别 → 保存数据
```

**核心功能**:
- 编码检测 (UTF-8, UTF-16LE, Latin1)
- 文本清洗和格式化
- 智能分段 (50-1000字)
- 段落类型识别 (章节/场景/对话/段落)

## 3. 角色分析 Agent

**实现**: `src/lib/llm-service.ts`

**工作流程**:
```
文本采样 → LLM分析 → 结果解析 → 角色创建 → 别名生成
```

**识别内容**:
- 角色名称和别名
- 性别、年龄
- 性格特征
- 对话风格
- 重要程度

**特殊处理**:
- 长文本分块 (最大8000字符)
- 角色信息合并
- 默认角色创建 (旁白、男主角、女主角)

## 4. 台本生成 Agent

**实现**: `src/lib/script-generator.ts`

**工作流程**:
```
准备角色映射 → 逐段处理 → LLM生成台词 → JSON修复 → 角色映射 → 保存数据库
```

**核心功能**:
- 对话识别和分配
- 情感分析
- 朗读指导生成
- 三级JSON修复机制

**三级修复**:
1. 直接解析
2. 本地语法修复
3. LLM智能修复

## 5. 音频生成 Agent

**实现**: `src/lib/audio-generator.ts`

**工作流程**:
```
获取台词 → 确定声音 → 构建请求 → 调用TTS → 保存文件 → 创建记录
```

**批量处理**:
- 默认每批5个
- 批次间延迟
- 并行处理
- 失败重试

**音频管理**:
- 跳过已存在
- 时长估算
- 失败重试
- 进度跟踪

## Agent 协作流程

### 完整处理流程

```
1. 用户上传 → 任务协调Agent创建Book和任务
2. 文本处理Agent → 解析分段保存
3. 任务协调Agent → 创建角色分析任务
4. 角色分析Agent → LLM识别角色
5. 任务协调Agent → 创建台本生成任务
6. 台本生成Agent → 逐段生成台词
7. 用户配置声音 → 绑定角色声音
8. 任务协调Agent → 创建音频生成任务
9. 音频生成Agent → 批量生成音频
10. 完成 → 用户下载
```

## 错误处理

### 错误类型
- `TTSError` - TTS服务错误
- `ValidationError` - 验证错误
- `FileProcessingError` - 文件处理错误

### 处理策略
- API层统一错误处理
- 服务层特定错误抛出
- 可重试错误自动重试
- 前端错误提示

## 性能优化

### 后端优化
- 文本分块处理
- 批量数据库操作
- 任务队列异步
- Redis缓存

### Agent优化
- 并行处理
- 增量生成
- 实时保存
- 进度反馈

## 扩展性

### 插件化设计
- TTS Provider接口
- LLM兼容API
- 文件格式扩展
- 任务类型扩展

### 水平扩展
- 无状态API
- 多Worker支持
- 数据库读写分离
- 对象存储支持

## 监控指标

- 任务处理时间
- Agent响应时间
- 错误率统计
- 资源使用情况
- LLM调用次数
- TTS调用次数

## 部署环境

### Docker 环境

系统运行在 Docker 容器环境中，具有以下特点：

- **数据库服务**: PostgreSQL 数据库运行在 Docker 容器中
- **应用服务**: Web 应用运行在单独的 Docker 容器中
- **环境变量**: 通过 Docker 环境配置文件管理，包括 `DATABASE_URL` 等关键配置
- **服务发现**: 容器间通过 Docker 网络进行通信

### 重要环境变量

- `DATABASE_URL`: PostgreSQL 数据库连接字符串
- `NEXT_PUBLIC_APP_URL`: 前端应用访问地址
- `APP_URL`: 后端服务访问地址

### 调试注意事项

当遇到 API 错误时，请检查：
1. Docker 服务是否正常运行
2. 环境变量是否正确设置
3. 数据库连接是否可用
4. 容器间网络通信是否正常

## 总结

Text to Voice 采用多Agent协作架构，每个Agent专注特定领域，通过任务协调Agent统一调度，实现了从文本到音频的完整自动化流程。系统设计注重模块化、可扩展性和容错性，在 Docker 容器化环境中稳定运行。
