generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Book {
  id                String                @id @default(uuid())
  title             String
  author            String?
  originalFilename  String?
  uploadedFilePath  String?
  fileSize          BigInt?
  totalWords        Int?
  totalCharacters   Int                   @default(0)
  totalSegments     Int                   @default(0)
  totalChapters     Int                   @default(0)
  encoding          String?
  fileFormat        String?
  status            String                @default("uploaded")
  metadata          Json                  @default("{}")
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  audioFiles        AudioFile[]
  mergeAudits       CharacterMergeAudit[]
  characterProfiles CharacterProfile[]
  processingTasks   ProcessingTask[]
  scriptSentences   ScriptSentence[]
  textSegments      TextSegment[]
  chapters          Chapter[]

  @@index([status, createdAt])
  @@index([author, createdAt])
  @@map("books")
}

model Chapter {
  id              String           @id @default(uuid())
  bookId          String
  chapterIndex    Int
  title           String
  rawTitle        String?
  startPosition   Int              @default(0)
  endPosition     Int              @default(0)
  wordCount       Int?             @default(0)
  characterCount  Int?             @default(0)
  totalSegments   Int              @default(0)
  status          String           @default("pending")
  metadata        Json?            @default("{}")
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  book            Book             @relation(fields: [bookId], references: [id], onDelete: Cascade)
  segments        TextSegment[]
  scriptSentences ScriptSentence[]
  audioFiles      AudioFile[]

  @@unique([bookId, chapterIndex])
  @@index([bookId])
  @@map("chapters")
}

model CharacterProfile {
  id                String                    @id @default(uuid())
  bookId            String
  canonicalName     String
  characteristics   Json                      @default("{}")
  voicePreferences  Json                      @default("{}")
  emotionProfile    Json                      @default("{}")
  genderHint        String                    @default("unknown")
  ageHint           Int?
  emotionBaseline   String                    @default("neutral")
  isActive          Boolean                   @default(true)
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  mentions          Int?                      @default(0)
  quotes            Int?                      @default(0)
  aliases           CharacterAlias[]
  mergeAuditsSource CharacterMergeAudit[]     @relation("SourceCharacter")
  mergeAuditsTarget CharacterMergeAudit[]     @relation("TargetCharacter")
  book              Book                      @relation(fields: [bookId], references: [id], onDelete: Cascade)
  voiceBindings     CharacterVoiceBinding[]
  speakerBindings   CharacterSpeakerBinding[]
  scriptSentences   ScriptSentence[]

  @@index([bookId])
  @@index([bookId, isActive])
  @@map("character_profiles")
}

model CharacterAlias {
  id             String           @id @default(uuid())
  characterId    String
  alias          String
  confidence     Decimal          @default(0.8) @db.Decimal(3, 2)
  sourceSentence String?
  createdAt      DateTime         @default(now())
  character      CharacterProfile @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([characterId])
  @@index([alias])
  @@map("character_aliases")
}

model TTSVoiceProfile {
  id                String                  @id @default(uuid())
  provider          String
  voiceId           String
  voiceName         String
  displayName       String
  description       String?
  characteristics   Json                    @default("{}")
  defaultParameters Json                    @default("{\"rate\": 1.0, \"pitch\": 1.0, \"volume\": 1.0}")
  previewAudio      Json?
  usageCount        Int                     @default(0)
  rating            Decimal                 @default(3.0) @db.Decimal(2, 1)
  isAvailable       Boolean                 @default(true)
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  audioFiles        AudioFile[]
  voiceBindings     CharacterVoiceBinding[]

  @@index([provider])
  @@index([isAvailable])
  @@map("tts_voice_profiles")
}

model CharacterVoiceBinding {
  id               String           @id @default(uuid())
  characterId      String
  voiceProfileId   String
  customParameters Json?
  emotionMappings  Json             @default("{}")
  isDefault        Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  character        CharacterProfile @relation(fields: [characterId], references: [id], onDelete: Cascade)
  voiceProfile     TTSVoiceProfile  @relation(fields: [voiceProfileId], references: [id], onDelete: Cascade)

  @@unique([characterId, voiceProfileId])
  @@index([characterId])
  @@map("character_voice_bindings")
}

model TextSegment {
  id                String           @id @default(uuid())
  bookId            String
  chapterId         String?
  segmentIndex      Int
  startPosition     Int
  endPosition       Int
  content           String
  wordCount         Int?
  segmentType       String?
  orderIndex        Int
  chapterOrderIndex Int?
  metadata          Json?
  status            String           @default("pending")
  createdAt         DateTime         @default(now())
  audioFiles        AudioFile[]
  scriptSentences   ScriptSentence[]
  book              Book             @relation(fields: [bookId], references: [id], onDelete: Cascade)
  chapter           Chapter?         @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@index([bookId])
  @@index([chapterId])
  @@index([bookId, orderIndex])
  @@index([chapterId, chapterOrderIndex])
  @@index([bookId, status])
  @@map("text_segments")
}

model ScriptSentence {
  id             String            @id @default(uuid())
  bookId         String
  segmentId      String
  chapterId      String?
  characterId    String?
  rawSpeaker     String?
  text           String
  orderInSegment Int
  tone           String?
  strength       Int?              @default(75)
  pauseAfter     Decimal?          @default(1.5) @db.Decimal(3, 1)
  ttsParameters  Json?
  createdAt      DateTime          @default(now())
  audioFiles     AudioFile[]
  book           Book              @relation(fields: [bookId], references: [id], onDelete: Cascade)
  character      CharacterProfile? @relation(fields: [characterId], references: [id])
  segment        TextSegment       @relation(fields: [segmentId], references: [id], onDelete: Cascade)
  chapter        Chapter?          @relation(fields: [chapterId], references: [id], onDelete: SetNull)

  @@index([segmentId])
  @@index([characterId])
  @@index([chapterId])
  @@index([bookId, segmentId, orderInSegment])
  @@index([bookId, orderInSegment])
  @@map("script_sentences")
}

model AudioFile {
  id             String           @id @default(uuid())
  bookId         String
  sentenceId     String?
  segmentId      String?
  chapterId      String?
  filePath       String
  fileName       String?
  duration       Decimal?         @db.Decimal(5, 2)
  fileSize       BigInt?
  format         String?
  status         String           @default("pending")
  errorMessage   String?
  retryCount     Int              @default(0)
  provider       String?
  voiceProfileId String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  book           Book             @relation(fields: [bookId], references: [id], onDelete: Cascade)
  segment        TextSegment?     @relation(fields: [segmentId], references: [id])
  scriptSentence ScriptSentence?  @relation(fields: [sentenceId], references: [id])
  voiceProfile   TTSVoiceProfile? @relation(fields: [voiceProfileId], references: [id])
  chapter        Chapter?         @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@index([bookId])
  @@index([status])
  @@index([bookId, status, createdAt])
  @@index([sentenceId, status])
  @@index([segmentId])
  @@index([chapterId])
  @@map("audio_files")
}

model CharacterMergeAudit {
  id                String           @id @default(uuid())
  bookId            String
  sourceCharacterId String
  targetCharacterId String
  mergeReason       String?
  mergedBy          String?
  createdAt         DateTime         @default(now())
  book              Book             @relation(fields: [bookId], references: [id], onDelete: Cascade)
  sourceCharacter   CharacterProfile @relation("SourceCharacter", fields: [sourceCharacterId], references: [id])
  targetCharacter   CharacterProfile @relation("TargetCharacter", fields: [targetCharacterId], references: [id])

  @@map("character_merge_audit")
}

model ProcessingTask {
  id             String    @id @default(uuid())
  bookId         String
  taskType       String
  status         String    @default("pending")
  progress       Int       @default(0)
  totalItems     Int       @default(0)
  processedItems Int       @default(0)
  taskData       Json      @default("{}")
  errorMessage   String?
  startedAt      DateTime?
  completedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  externalTaskId String?
  book           Book      @relation(fields: [bookId], references: [id], onDelete: Cascade)

  @@index([bookId])
  @@index([status])
  @@index([bookId, status, createdAt])
  @@index([taskType, status])
  @@index([externalTaskId])
  @@map("processing_tasks")
}

model SpeakerProfile {
  name              String?
  gender            String                    @default("unknown")
  ageGroup          String                    @default("adult") @map("age_group")
  toneStyle         String                    @default("neutral") @map("tone_style")
  description       String?
  referenceAudio    String?                   @map("reference_audio")
  confidence        Decimal?                  @db.Decimal(5, 4)
  embeddingVector   Bytes?                    @map("embedding_vector")
  metadata          Json                      @default("{}")
  isActive          Boolean                   @default(true) @map("is_active")
  usageCount        Int                       @default(0) @map("usage_count")
  lastUsedAt        DateTime?                 @map("last_used_at")
  syncedAt          DateTime?                 @map("synced_at")
  createdAt         DateTime                  @default(now()) @map("created_at")
  updatedAt         DateTime                  @updatedAt @map("updated_at")
  id                Int                       @id @default(autoincrement()) @map("speaker_id")
  characterBindings CharacterSpeakerBinding[]

  @@index([isActive])
  @@index([gender])
  @@index([ageGroup])
  @@map("speaker_profiles")
}

model CharacterSpeakerBinding {
  id               String           @id @default(uuid())
  characterId      String
  speakerProfileId Int
  metadata         Json             @default("{}")
  isDefault        Boolean          @default(true)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  character        CharacterProfile @relation(fields: [characterId], references: [id], onDelete: Cascade)
  speakerProfile   SpeakerProfile   @relation(fields: [speakerProfileId], references: [id], onDelete: Cascade)

  @@unique([characterId, speakerProfileId])
  @@index([characterId])
  @@map("character_speaker_bindings")
}
