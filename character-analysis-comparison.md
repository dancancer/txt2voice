# Sample.txt 角色识别对比分析

## 统计概览

| 指标 | 我的分析 | 服务分析 |
|------|---------|---------|
| 识别角色数 | 9个 | 8个 |
| 主要角色覆盖 | 100% | 37.5% (仅3/8) |
| 对话次数统计 | ✅ 正确 | ❌ **全部为0** |
| 别名识别 | ✅ 正确 | ❌ **全部为空** |

---

## 详细对比

### ✅ 正确识别的角色

| 角色名 | 我的分析 | 服务分析 | 差异 |
|--------|---------|---------|------|
| **齐夏** | 提及20次，对话0次 | 提及17次，对话0次 | mentions略有差异 |
| **甜甜** | 提及35次，对话12次 | 提及12次，**对话0次** | ❌ 对话数完全错误 |
| **花臂男** | 提及18次，对话6次 | 提及2次，**对话0次** | ❌ 严重低估 |

### ❌ 漏识别的主要角色

| 角色名 | 实际情况 | 服务是否识别 |
|--------|---------|-------------|
| **山羊头/人羊** | 提及~50次，对话~25次（最重要的角色！） | ❌ **完全缺失** |
| **健硕男人** | 提及~25次，对话~8次（战术策划者） | ❌ 缺失 |
| **白大褂** | 提及~10次，对话~3次 | ❌ 缺失 |
| **清冷女人** | 提及~12次，对话~3次 | ❌ 缺失 |
| **死去的年轻人** | 提及~8次（第一个被杀） | ❌ 缺失 |
| **尖叫女生** | 提及~3次 | ❌ 缺失 |

### ⚠️ 误识别的角色

服务错误地将以下内容识别为角色：

| 错误识别 | 实际情况 |
|---------|---------|
| **女娲** (7次) | 神话人物，被作为话题讨论，**不是小说角色** |
| **小芳** (1次) | 文中举例的陪酒小姐常用化名，**不是实际角色** |
| **丽丽** (1次) | 同上，举例的化名 |
| **李明** (1次) | 齐夏计划使用的假名，**还未使用** |
| **张丽娟** (1次) | 甜甜的真名，应作为**甜甜的别名**而非独立角色 |

---

## 核心问题分析

### 🔴 问题1：对话次数全部为0

**现象：** 所有角色的 `quotes` 字段都是 0，但文中有大量对话

**示例对话：**
```
"早安，九位。" 山羊头率先说话了
"你……是谁？" 纹着花臂的男人问道
"我叫甜甜，是个……呃……是个「技术工作者」。"
"你这叫什么话？" 健硕男人的面色有些微怒
```

**根本原因分析：**
- 对话检测逻辑失效
- 可能的问题点：
  1. 引号识别（使用了中文引号「」和 ""）
  2. dialogue_count 计算逻辑有 bug
  3. 对话归属到角色的逻辑未执行

### 🔴 问题2：别名识别完全失败

**现象：** 所有角色的 `aliases` 字段都是空数组

**应该识别的别名：**
- **山羊头** = 人羊 = 羊头人 = 山羊面具
- **甜甜** = 张丽娟（真名）
- **白大褂** = 中年男人 = 穿着白大褂的中年男人
- **健硕男人** = 黑色T恤的健壮年轻人 = 年轻男人
- **花臂男** = 纹着花臂的男人

**根本原因分析：**
- 别名合并逻辑未生效
- NER 识别了多个指代同一人的称呼，但未进行合并
- Coreference resolution (指代消解) 失败

### 🔴 问题3：主角"山羊头"完全缺失

**现象：** 全文最重要的角色"山羊头/人羊"完全没有被识别

**文本证据：**
- 第7行首次出现："戴着山羊头面具、身穿黑色西服的男人"
- 第14行开始大量对话
- 贯穿全文的核心角色

**可能原因：**
1. "山羊头"被误判为名词短语而非人名
2. NER 模型未将"面具的名字"识别为角色指代
3. 特殊的命名方式（非常规人名）导致遗漏

### 🔴 问题4：误将非角色识别为角色

**问题案例：**

1. **女娲**（神话人物）
   - 文本："曾经的女娲创造了人类"
   - 只是被讨论的话题，非小说角色

2. **小芳、丽丽**（举例的化名）
   - 文本："像「甜甜」、「小芳」、「丽丽」这种化名很常见"
   - 这是举例说明，非实际角色

3. **李明**（未使用的假名）
   - 文本："所以他准备叫自己「李明」"
   - 这是角色的想法，还未实施

**根本原因：**
- 缺少上下文理解
- NER 只看到了人名形式，未理解语义
- 需要增加过滤规则：
  - 排除"像...这种"等举例句式中的名字
  - 排除"准备叫...""计划用..."等意图表达中的名字
  - 排除历史/神话人物

### 🔴 问题5：角色重要性评分失效

**现象：** 所有角色的 `importance` 都是 "minor"

**实际情况：**
- **主角级：** 山羊头（组织者）、齐夏（说谎者视角）
- **重要配角：** 甜甜、健硕男人、花臂男、白大褂、清冷女人
- **次要角色：** 死去的年轻人、尖叫女生

**问题：** 重要性算法完全失效，未能根据 mentions 和 dialogues 计算权重

---

## 代码问题定位

### 1. 对话统计逻辑（dialogue_count）

**位置：** `apps/character-recognition/src/core/ner.py` 或 dialogue 处理模块

**需要检查：**
```python
# 检查是否正确识别中文引号
dialogue_patterns = [
    r'"([^"]+)"',      # 英文双引号
    r'「([^」]+)」',    # 日式引号
    r'"([^"]+)"',      # 中文引号
]

# 检查是否正确关联角色到对话
# 示例："早安，九位。"山羊头率先说话了
# 需要识别：对话 + 说话者动词 + 角色名
```

### 2. 别名合并逻辑（aliases）

**位置：** `apps/character-recognition/src/recognizer.py` 的 merge 或 coreference 阶段

**需要检查：**
```python
# 是否执行了指代消解
# 是否合并了相似的名称
# 例如："山羊头" 和 "人羊" 和 "羊头人" 应该合并
```

### 3. NER 实体识别（缺失主角）

**位置：** `apps/character-recognition/src/core/ner.py`

**需要检查：**
```python
# HanLP 的 NER 配置
# 是否只识别标准人名格式？
# 如何处理"山羊头"这种特殊称呼？
```

### 4. 后处理过滤（误识别）

**建议添加：**
```python
def filter_false_positives(characters, text):
    """过滤误识别的角色"""

    # 1. 排除举例句式中的名字
    example_patterns = [
        r'像.+?这种',
        r'比如.+?等',
    ]

    # 2. 排除意图表达中的名字
    intent_patterns = [
        r'准备叫.+?',
        r'计划用.+?',
    ]

    # 3. 排除历史/神话人物
    myth_names = ['女娲', '盘古', '后羿', ...]

    return filtered_characters
```

---

## 推荐修复方案

### 优先级1：修复对话统计

1. 增强引号识别
2. 改进对话归属逻辑
3. 测试验证

### 优先级2：修复别名识别

1. 启用指代消解模型
2. 添加相似度匹配逻辑
3. 合并同义称呼

### 优先级3：改进 NER 实体识别

1. 扩展人名识别规则（支持"山羊头"这类特殊称呼）
2. 增加上下文分析
3. 区分说话者和被提及者

### 优先级4：增强过滤规则

1. 添加语义理解
2. 过滤举例和意图表达中的名字
3. 排除神话/历史人物

---

## 结论

**character-recognition 服务存在严重的功能缺陷：**

1. ❌ **对话统计完全失效** - 所有角色 dialogue_count = 0
2. ❌ **别名识别完全失效** - 所有角色 aliases = []
3. ❌ **主角识别缺失** - "山羊头"等主要角色未识别
4. ❌ **误识别严重** - 将非角色识别为角色
5. ❌ **重要性评分失效** - 所有角色都是 "minor"

**唯一正常工作的功能：**
- ✅ mentions 统计（部分准确，但也有遗漏）

**服务当前状态：**
基本不可用于实际生产环境，需要全面修复核心逻辑。
