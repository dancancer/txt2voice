version: '3.8'

services:
  # 开发模式的Web应用（支持热更新）
  # 注意：此配置需要与 docker-compose.yml 一起使用
  # 使用方式: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up
  web:
    # 使用开发专用的 Dockerfile
    build:
      context: .
      dockerfile: apps/web/Dockerfile.dev
    env_file:
      - .env
    volumes:
      # 挂载源代码以支持热更新
      - ./apps/web/src:/app/apps/web/src:cached
      - ./apps/web/public:/app/apps/web/public:cached
      - ./apps/web/prisma:/app/apps/web/prisma:cached
      - ./apps/web/package.json:/app/apps/web/package.json:cached
      - ./apps/web/next.config.dev.js:/app/apps/web/next.config.js:cached
      - ./apps/web/tsconfig.json:/app/apps/web/tsconfig.json:cached
      - ./apps/web/tailwind.config.ts:/app/apps/web/tailwind.config.ts:cached
      - ./apps/web/postcss.config.js:/app/apps/web/postcss.config.js:cached
      - ./package.json:/app/package.json:cached
      - ./pnpm-workspace.yaml:/app/pnpm-workspace.yaml:cached
      # 排除node_modules、.next和生成的Prisma Client（避免覆盖容器内的）
      - /app/node_modules
      - /app/apps/web/node_modules
      - /app/apps/web/.next
      - /app/apps/web/src/generated/prisma
      # 上传目录
      - uploads_data:/app/apps/web/uploads
    environment:
      NODE_ENV: development
      PORT: 3001
      # 启用文件监听轮询（Docker 环境必需）
      WATCHPACK_POLLING: "true"
      CHOKIDAR_USEPOLLING: "true"
    ports:
      - "3001:3001"
    # 使用开发服务器（命令已在 Dockerfile.dev 中定义）
    # command 会覆盖 Dockerfile 中的 CMD，这里注释掉使用默认命令
