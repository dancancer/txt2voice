# ä¸­æ–‡å°è¯´äººç‰©è¯†åˆ«é¡¹ç›® - åˆ›å»ºæ€»ç»“

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

å·²åœ¨ `apps/character-recognition` ç›®å½•ä¸‹æˆåŠŸåˆ›å»ºäº†ä¸€ä¸ªå®Œæ•´çš„ä¸­æ–‡å°è¯´äººç‰©è¯†åˆ«ç³»ç»Ÿã€‚è¯¥é¡¹ç›®ä½œä¸º txt2voice monorepo çš„ä¸€ä¸ªç‹¬ç«‹å­é¡¹ç›®ï¼Œæä¾›åŸºäº FastAPI çš„ RESTful API æœåŠ¡ã€‚

> âš ï¸ **2025-02 æ›´æ–°**ï¼šç³»ç»Ÿå·²åˆ‡æ¢è‡³ LLMï¼ˆGemini/DeepSeek/OpenAIï¼‰å®Œæˆè§’è‰²è¯†åˆ«ï¼Œ`apps/character-recognition` ä»…ä½œå†å²ç¤ºä¾‹ä¿ç•™ã€‚æœ¬æ–‡æ¡£ä»…ä¾›å‚è€ƒï¼Œä¸å†å¯¹åº”çº¿ä¸Šå®ç°ã€‚

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½

1. **äººåè¯†åˆ«** (NER)
   - åŸºäº HanLP é¢„è®­ç»ƒæ¨¡å‹
   - è§„åˆ™è¡¥å……è¯†åˆ«ï¼ˆå§“æ° + åå­—æ¨¡å¼ï¼‰
   - æ”¯æŒ 2-4 å­—ä¸­æ–‡åè¯†åˆ«

2. **åˆ«åè¯†åˆ«ä¸åˆå¹¶**
   - å‰ç¼€è¯†åˆ«ï¼šè€å¼ ã€å°æã€é˜¿æœˆ
   - åç¼€è¯†åˆ«ï¼šç‹å”ã€å®ç‰å“¥ã€å¤§å°å§
   - å„¿åŒ–éŸ³ï¼šæœˆå„¿ã€æ—ºè´¢å„¿
   - åŸºäºæ ¸å¿ƒåå½’ä¸€åŒ–
   - å¥å‘é‡è¯­ä¹‰èšç±»ï¼ˆå¯é€‰ï¼‰

3. **æŒ‡ä»£æ¶ˆè§£**
   - ä»£è¯è¯†åˆ«ï¼šä»–/å¥¹/ä»–ä»¬/å¥¹ä»¬
   - å¯å‘å¼å›æŒ‡ï¼ˆæœ€è¿‘å‡ºç° + æ€§åˆ«åŒ¹é…ï¼‰
   - å¯¹è¯ä¸Šä¸‹æ–‡ä¼˜å…ˆ

4. **å¯¹è¯å½’å› **
   - ä¸‰ç§å¯¹è¯æ¨¡å¼è¯†åˆ«
   - è¯´è¯è€…è‡ªåŠ¨æ ‡æ³¨
   - å°è¯ç»Ÿè®¡

5. **å…³ç³»æŠ½å–**
   - å…±ç°å…³ç³»ç»Ÿè®¡
   - å¯¹è¯å…³ç³»è¯†åˆ«
   - æƒé‡è®¡ç®—

### è¾“å‡ºç»“æ„

```json
{
  "characters": [
    {
      "id": "c001",
      "name": "é›…èŠ™",
      "aliases": ["å¤§å°å§"],
      "mentions": 12,
      "first_appearance_idx": 121,
      "gender": "å¥³",
      "roles": ["è€æ¿çš„å¥³å„¿"],
      "quotes": 7
    }
  ],
  "alias_map": { "å¤§å°å§": "é›…èŠ™" },
  "relations": [
    { "from": "ç‹å¼º", "to": "é›…èŠ™", "type": "å¯¹è¯", "weight": 7 }
  ],
  "statistics": {
    "total_characters": 5,
    "total_mentions": 50,
    "total_dialogues": 20,
    "processing_time": 1.23
  }
}
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
apps/character-recognition/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ models/              # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ character.py     # Character, Relation
â”‚   â”‚   â”œâ”€â”€ request.py       # RecognitionRequest
â”‚   â”‚   â””â”€â”€ response.py      # RecognitionResponse
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                # æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ preprocessor.py  # æ–‡æœ¬é¢„å¤„ç†ï¼ˆåˆ†å¥ã€æ¸…æ´—ï¼‰
â”‚   â”‚   â”œâ”€â”€ ner.py          # NERè¯†åˆ«ï¼ˆHanLP + è§„åˆ™ï¼‰
â”‚   â”‚   â”œâ”€â”€ alias.py        # åˆ«åè¯†åˆ«ä¸åˆå¹¶
â”‚   â”‚   â”œâ”€â”€ coreference.py  # æŒ‡ä»£æ¶ˆè§£
â”‚   â”‚   â”œâ”€â”€ dialogue.py     # å¯¹è¯å½’å› 
â”‚   â”‚   â””â”€â”€ relation.py     # å…³ç³»æŠ½å–
â”‚   â”‚
â”‚   â”œâ”€â”€ recognizer.py       # ä¸»è¯†åˆ«å™¨ï¼ˆPipelineï¼‰
â”‚   â”œâ”€â”€ config.py           # é…ç½®ï¼ˆSettingsï¼‰
â”‚   â””â”€â”€ utils.py            # å·¥å…·å‡½æ•°
â”‚
â”œâ”€â”€ tests/                  # æµ‹è¯•æ–‡ä»¶
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ test_basic.py
â”‚
â”œâ”€â”€ main.py                 # FastAPI åº”ç”¨å…¥å£
â”œâ”€â”€ example.py              # ä½¿ç”¨ç¤ºä¾‹
â”œâ”€â”€ requirements.txt        # Python ä¾èµ–
â”œâ”€â”€ Dockerfile             # Docker é…ç½®
â”œâ”€â”€ .dockerignore
â”œâ”€â”€ .env.example
â”œâ”€â”€ .gitignore
â”œâ”€â”€ README.md              # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ QUICK_START.md         # å¿«é€Ÿå¼€å§‹æŒ‡å—
â””â”€â”€ INTEGRATION.md         # é›†æˆæŒ‡å—
```

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: FastAPI 0.104.1
- **NLP æ ¸å¿ƒ**:
  - HanLP 2.1.0 (ä¸­æ–‡ NER)
  - sentence-transformers 2.2.2 (å¥å‘é‡)
  - text2vec 1.2.1 (ä¸­æ–‡å¥å‘é‡)
  - FAISS 1.7.4 (å‘é‡æ£€ç´¢)
- **å·¥å…·**:
  - Jieba (åˆ†è¯)
  - pypinyin (æ‹¼éŸ³)
  - loguru (æ—¥å¿—)
  - pydantic (æ•°æ®éªŒè¯)

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æœ¬åœ°å¼€å‘

```bash
cd apps/character-recognition

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# è¿è¡Œç¤ºä¾‹
python example.py

# å¯åŠ¨æœåŠ¡
python main.py
# è®¿é—® http://localhost:8001/docs
```

### Docker éƒ¨ç½²

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•
docker-compose up -d character-recognition

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f character-recognition

# æµ‹è¯•æœåŠ¡
curl http://localhost:8001/health
```

## ğŸ”Œ API æ¥å£

### ä¸»è¦ç«¯ç‚¹

1. **POST /api/recognize** - è¯†åˆ«äººç‰©
   ```json
   {
     "text": "å°è¯´æ–‡æœ¬å†…å®¹",
     "options": {
       "enable_coreference": true,
       "enable_dialogue": true,
       "enable_relations": true,
       "similarity_threshold": 0.8,
       "max_characters": 50
     }
   }
   ```

2. **GET /health** - å¥åº·æ£€æŸ¥
3. **GET /api/stats** - ç»Ÿè®¡ä¿¡æ¯
4. **GET /docs** - Swagger API æ–‡æ¡£
5. **GET /redoc** - ReDoc API æ–‡æ¡£

## ğŸ”— ä¸ä¸»åº”ç”¨é›†æˆ

### åœ¨ docker-compose.yml ä¸­

å·²æ·»åŠ  `character-recognition` æœåŠ¡ï¼š
- ç«¯å£: 8001
- ä¾èµ–: æ— ï¼ˆç‹¬ç«‹æœåŠ¡ï¼‰
- å·: character_modelsï¼ˆç¼“å­˜æ¨¡å‹ï¼‰

### åœ¨ Next.js ä¸­è°ƒç”¨

```typescript
// apps/web/src/lib/character-api.ts
export async function recognizeCharacters(text: string) {
  const apiUrl = process.env.CHARACTER_RECOGNITION_URL || 
                 'http://localhost:8001';
  
  const response = await fetch(`${apiUrl}/api/recognize`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ text })
  });
  
  return response.json();
}
```

ç¯å¢ƒå˜é‡å·²åœ¨ docker-compose.yml ä¸­é…ç½®ï¼š
```yaml
CHARACTER_RECOGNITION_URL: http://character-recognition:8001
```

## ğŸ“Š å¤„ç†æµç¨‹

```
è¾“å…¥æ–‡æœ¬
    â†“
æ–‡æœ¬é¢„å¤„ç†ï¼ˆæ¸…æ´—ã€åˆ†å¥ï¼‰
    â†“
NERè¯†åˆ«ï¼ˆHanLP + è§„åˆ™ï¼‰
    â†“
åˆ«åè¯†åˆ«ï¼ˆè§„åˆ™æ¨¡æ¿ï¼‰
    â†“
å®ä½“åˆå¹¶ï¼ˆæ ¸å¿ƒåå½’ä¸€åŒ– + ç›¸ä¼¼åº¦èšç±»ï¼‰
    â†“
æŒ‡ä»£æ¶ˆè§£ï¼ˆå¯å‘å¼è§„åˆ™ï¼‰
    â†“
å¯¹è¯å½’å› ï¼ˆæ¨¡å¼åŒ¹é…ï¼‰
    â†“
å…³ç³»æŠ½å–ï¼ˆå…±ç°ç»Ÿè®¡ï¼‰
    â†“
ç»“æ„åŒ–è¾“å‡º
```

## ğŸ¨ é…ç½®é€‰é¡¹

ä¸»è¦å¯é…ç½®å‚æ•°ï¼ˆ`src/config.py`ï¼‰ï¼š

- `SIMILARITY_THRESHOLD`: åˆ«ååˆå¹¶ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆé»˜è®¤ 0.8ï¼‰
- `NAME_PREFIXES`: ç§°å‘¼å‰ç¼€åˆ—è¡¨
- `NAME_HONORIFICS`: æ•¬ç§°åç¼€åˆ—è¡¨
- `DIALOGUE_TRIGGERS`: å¯¹è¯è§¦å‘è¯
- `MAX_COREFERENCE_DISTANCE`: æŒ‡ä»£æ¶ˆè§£æœ€å¤§å›æº¯å¥æ•°
- `MIN_RELATION_WEIGHT`: æœ€å°å…³ç³»æƒé‡

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

é¢„æœŸæ€§èƒ½ï¼ˆåŸºäº HanLP + CPUï¼‰ï¼š
- çŸ­æ–‡æœ¬ï¼ˆ<1000å­—ï¼‰: <2ç§’
- ä¸­ç­‰æ–‡æœ¬ï¼ˆ1000-5000å­—ï¼‰: 2-10ç§’
- é•¿æ–‡æœ¬ï¼ˆ5000-20000å­—ï¼‰: 10-60ç§’

ä¼˜åŒ–å»ºè®®ï¼š
- ä½¿ç”¨ GPU åŠ é€Ÿï¼ˆä¿®æ”¹ requirements.txtï¼‰
- åˆ†å—å¤„ç†é•¿æ–‡æœ¬
- å¯ç”¨æ¨¡å‹ç¼“å­˜
- ä½¿ç”¨è½»é‡çº§æ¨¡å‹

## ğŸ“š æ–‡æ¡£

- **README.md** - å®Œæ•´é¡¹ç›®æ–‡æ¡£
- **QUICK_START.md** - 5åˆ†é’Ÿå¿«é€Ÿå¼€å§‹
- **INTEGRATION.md** - è¯¦ç»†é›†æˆæŒ‡å—
- **../../äººç‰©è¯†åˆ«æ–¹æ¡ˆ.md** - è®¾è®¡æ–¹æ¡ˆ
- **../../NERæ¨¡å‹é€‰å‹.md** - æŠ€æœ¯é€‰å‹

## ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œæµ‹è¯•
cd apps/character-recognition
pytest tests/ -v

# è¿è¡Œç¤ºä¾‹
python example.py
```

## ğŸ”„ å¼€å‘é˜¶æ®µ

- [x] P0: é¡¹ç›®ç»“æ„æ­å»º
- [x] P0: æ–‡æœ¬é¢„å¤„ç† + NER + åˆ«åè§„åˆ™
- [x] P1: æ ¸å¿ƒåå½’ä¸€åŒ– + åˆ«åèšåˆ
- [x] P2: å¯¹è¯å½’å›  + æŒ‡ä»£æ¶ˆè§£
- [x] P3: äººç‰©å…³ç³»æŠ½å–
- [ ] P3: å…³ç³»å›¾å¯è§†åŒ–
- [ ] P4: äººç‰©ç”»åƒï¼ˆæ€§æ ¼/æƒ…ç»ª/ç«‹åœºï¼‰
- [ ] P4: LLM è¾…åŠ©æ ¡å¯¹

## ğŸ› å·²çŸ¥é™åˆ¶

1. **æ¨¡å‹ä¾èµ–**: é¦–æ¬¡è¿è¡Œéœ€ä¸‹è½½ 1-2GB æ¨¡å‹
2. **è¯­ä¹‰åˆå¹¶**: å½“å‰ä»…å®ç°è§„åˆ™åˆå¹¶ï¼Œå¥å‘é‡èšç±»éœ€è¿›ä¸€æ­¥ä¼˜åŒ–
3. **æŒ‡ä»£æ¶ˆè§£**: å¤æ‚æƒ…å†µå¤„ç†æœ‰é™ï¼Œå¯èƒ½éœ€è¦æ›´æ·±å±‚æ¨¡å‹
4. **æ€§èƒ½**: CPU æ¨¡å¼ä¸‹å¤„ç†é•¿æ–‡æœ¬è¾ƒæ…¢

## ğŸš§ åç»­ä¼˜åŒ–

1. **ç²¾åº¦æå‡**
   - å®Œå–„è¯­ä¹‰ç›¸ä¼¼åº¦åˆå¹¶
   - å¢å¼ºæŒ‡ä»£æ¶ˆè§£æ¨¡å‹
   - æ·»åŠ  LLM è¾…åŠ©åˆ¤æ–­

2. **æ€§èƒ½ä¼˜åŒ–**
   - GPU åŠ é€Ÿ
   - æ¨¡å‹é‡åŒ–
   - åˆ†å¸ƒå¼å¤„ç†

3. **åŠŸèƒ½æ‰©å±•**
   - äººç‰©ç”»åƒåˆ†æ
   - æƒ…æ„Ÿåˆ†æ
   - å…³ç³»å›¾è°±å¯è§†åŒ–
   - WebSocket å®æ—¶å¤„ç†

4. **å·¥ç¨‹ä¼˜åŒ–**
   - ç»“æœç¼“å­˜ï¼ˆRedisï¼‰
   - é˜Ÿåˆ—å¤„ç†ï¼ˆé•¿æ–‡æœ¬ï¼‰
   - ç›‘æ§å‘Šè­¦
   - A/B æµ‹è¯•

## ğŸ“ å‚è€ƒèµ„æ–™

- [äººç‰©è¯†åˆ«æ–¹æ¡ˆ.md](../../äººç‰©è¯†åˆ«æ–¹æ¡ˆ.md)
- [NERæ¨¡å‹é€‰å‹.md](../../NERæ¨¡å‹é€‰å‹.md)
- [HanLP æ–‡æ¡£](https://hanlp.hankcs.com/)
- [Text2Vec æ–‡æ¡£](https://github.com/shibing624/text2vec)
- [FastAPI æ–‡æ¡£](https://fastapi.tiangolo.com/)

## âœ… é¡¹ç›®çŠ¶æ€

**å½“å‰çŠ¶æ€**: âœ… å·²å®ŒæˆåŸºç¡€åŠŸèƒ½ï¼Œå¯ä»¥æ­£å¸¸è¿è¡Œå’Œæµ‹è¯•

**ä¸‹ä¸€æ­¥**:
1. æµ‹è¯•æœ¬åœ°è¿è¡Œ
2. ä¸ Web åº”ç”¨é›†æˆ
3. Docker éƒ¨ç½²éªŒè¯
4. æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–

---

åˆ›å»ºæ—¶é—´: 2024å¹´11æœˆ11æ—¥
åˆ›å»ºè€…: AI Assistant
ç‰ˆæœ¬: 1.0.0
